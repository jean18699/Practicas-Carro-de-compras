<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>Nuevo Producto</title>


    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0-beta/css/bootstrap.min.css"
          integrity="sha384-/Y6pD6FV/Vv2HJnA6t+vslU6fwYXjCFtcEpHbNJ0lyAFsXTsjBbfaDjzALeQsN6M" crossorigin="anonymous">
    <script src="https://code.jquery.com/jquery-3.2.1.slim.min.js"
            integrity="sha384-KJ3o2DKtIkvYIK3UENzmM7KCkRr/rE9/Qpg6aAZGJwFDMVNA/GpGFF93hXpG5KkN"
            crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.11.0/umd/popper.min.js"
            integrity="sha384-b/U6ypiBEHpOf/4+1nzFpr53nxSS+GLCkfwBdFNTxtclqqenISfwAzpKaMNFNmj4"
            crossorigin="anonymous"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0-beta/js/bootstrap.min.js"
            integrity="sha384-h0AbiXch4ZDo7tp9hKZ4TsHbi047NrKGLO3SEJAg45jXxnGIfYzk4Si90RDIqNm1"
            crossorigin="anonymous"></script>

</head>
<body>
<header>
    <nav class="navbar navbar-expand-lg navbar-dark bg-dark">
        <a th:href="@{/listaProductos/1}" class="navbar-brand" style="color:white;"><strong>JG SHOPPING</strong></a>
        <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarNavDropdown"
                aria-controls="navbarNavDropdown" aria-expanded="false" aria-label="Toggle navigation">
            <span class="navbar-toggler-icon"></span>
        </button>
        <div class="collapse navbar-collapse" id="navbarNavDropdown">
            <ul class="navbar-nav mb-2 mb-lg-0 navbar-nav ml-auto">
                <li th:if="${usuario == 'admin'}" class="nav-item active">
                    <b><a class="nav-link"  th:href="@{/dashboard}">Dashboard</a></b>
                </li>
                <li class="nav-item active">
                    <b><a class="nav-link" href="/listaProductos/1">Comprar</a></b>
                </li>
                <li class="nav-item active">
                    <b><a id="menuUsuario" class="nav-link" th:href="@{/listaUsuarios}">Usuarios</a></b>
                </li>
                <li th:if="${usuario == 'admin'}" class="nav-item active">
                    <b><a class="nav-link" th:href="@{/ventas}">Ventas Realizadas</a></b>
                </li>
                <li th:if="${usuario == 'admin'}" class="nav-item active">
                    <b><a class="nav-link" th:href="@{/controlProductos/1}">Administrar Productos</a></b>
                </li>
                <li class="nav-item active">
                    <b><a class="nav-link" th:text="'Carrito(' + ${cantidadCarrito}+')'" th:href="@{/carrito}">0</a></b>
                </li>
                <li th:if="${usuario != null}" class="nav-item active">
                    <b><a class="nav-link" th:href="@{/cerrarSesion}">Cerrar Sesion</a></b>
                </li>
                <li th:if="${usuario == null}" class="nav-item active">
                    <b><a class="nav-link" th:href="@{/iniciarSesion}">Iniciar Sesion</a></b>
                </li>
            </ul>

        </div>
    </nav>
</header>

<div class="row">&nbsp;</div>
<div class="row">&nbsp;</div>
<div class="row">&nbsp;</div>


<h3 align="center">Datos del Producto</h3>

<div class="row">&nbsp;</div>
<div class="row">&nbsp</div>
<div class="row">&nbsp;</div>

<div class="row justify-content-center">

    <div class="card" style="width: 75%">
        <div align="center" class="card-title"><h4 th:text="${producto.nombre}">NombreProducto</h4></div>
        <div class="card-body">
            <div class="col-sm-12">
                <div id="carouselExampleIndicators" class="carousel slide" data-ride="carousel">
                    <div class="carousel-inner">
                        <div th:each="foto,iterstat : ${producto.fotos}"
                             th:class="${iterstat.index} == 0 ? 'carousel-item active' : 'carousel-item'">
                            <img class="d-block w-100" height="300"
                                 th:src="@{'data:'+${foto.getMimeType()}+';base64,'+${foto.getFotoBase64()}}">
                        </div>
                    </div>
                    <a class="carousel-control-prev" href="#carouselExampleIndicators" role="button" data-slide="prev">
                        <span class="carousel-control-prev-icon" aria-hidden="true"></span>
                        <span class="sr-only">Previous</span>
                    </a>
                    <a class="carousel-control-next" href="#carouselExampleIndicators" role="button" data-slide="next">
                        <span class="carousel-control-next-icon" aria-hidden="true"></span>
                        <span class="sr-only">Next</span>
                    </a>
                </div>
            </div>
            <div class="row">&nbsp;</div>
            <div class="row">

                <div class="col-6">
                    <label for="nombreProducto" class="form-label"><b>Nombre</b></label>
                    <input type="text" th:value="${producto.nombre}" id="nombreProducto" class="form-control"
                           name="nombreProducto" disabled fullwidth required>
                </div>
                <div class="col-6">
                    <label for="precioProducto" class="form-label"><b>Precio</b></label>
                    <input type="number" th:value="${producto.precio}" id="precioProducto" class="form-control"
                           name="precioProducto" disabled min="1" fullwidth required>
                </div>
            </div>

            <div class="row">&nbsp;</div>
            <div class="row">
                <div class="col-12">
                    <label for="nombreProducto" class="form-label"><b>Descripcion</b></label>
                    <input type="text" th:value="${producto.descripcion}" id="descripcionProducto" class="form-control"
                           name="descripcionProducto" disabled fullwidth required>
                </div>
            </div>

            <div class="row">&nbsp;</div>
            <form th:action="@{/carrito/agregar}" method="post">
                <div class="row">
                    <div class="col-6">
                        <label for="cantidadProducto" class="form-label"><b>Cantidad a comprar: </b></label>
                        <input id="cantidadProducto" fullwidth name="cantidad" value="1" class="form-control"
                               type="number" min="1" placeholder="1"/>
                    </div>
                </div>
                <div class="row" align="right">
                    <div class="col-md-12" align="right">
                        <button name="idProducto" th:value="${producto.id}" type="submit" class="btn btn-primary">
                            Agregar al carrito
                        </button>
                        <button name="volver" form="volverForm" type="submit" class="btn btn-danger">Volver</button>
                    </div>
                </div>
            </form>

        </div>

        <form id="volverForm" th:action="@{/listaProductos/1}" method="get"></form>

        <div class="card-footer">
            <table class="table table-hover table-responsive table-bordered">
                <thead class="thead-light">
                <tr align="center">
                    <th scope="col">Usuario</th>
                    <th style="white-space:pre-wrap; word-wrap: break-word; width:75%" scope="col">Mensaje</th>
                    <th th:if="${usuario == 'admin'}" scope="col">Accion</th>
                </tr>
                </thead>
                <tbody id="seccionComentarios" class="table-hover"></tbody>
            </table>
        </div>
        <div th:if="${usuario != null}" class="card-footer">
            <form th:action="@{/listaProductos/verProducto/enviarComentario/}+${producto.id}" method="post">
                <div class="row">
                    <div class="col-6">
                        <textarea type="text" name="comentario" rows="5" cols="65" id="comentario"></textarea>
                    </div>
                </div>
                <div class="row">&nbsp;</div>
                <div class="row">
                    <div class="col-12">
                        <div class="col-2">
                            <button id="btnComentar" type="button" name="comentar" class="btn btn-primary">Enviar comentario</button>
                        </div>
                    </div>
                </div>
            </form>
        </div>
        <div th:if="${usuario == null}" class="card-footer">

                <div class="row">
                    <div class="col-6">
                        <h5>Inicia sesion para ver los comentarios</h5>
                    </div>
                </div>
                <div class="row">&nbsp;</div>

        </div>

    </div>

</div>

<script>

    var webSocket;
    var id;

    function conectar()
    {
        /*<![CDATA[*/
        console.log("ws://"+location.hostname+":"+location.port+"/comentarios/[(@{${producto.id}})]")
        webSocket = new WebSocket("ws://"+location.hostname+":"+location.port+"/comentarios/[(@{${producto.id}})]");
        /*]]>*/
        webSocket.onopen = function(e){}
        webSocket.onclose = function(e){}
        webSocket.onmessage = function(data){
            $(document).ready(function(){
                if(!isNaN(data.data))
                {
                    $('#seccionComentarios tr td button[value ="'+data.data+'"]').parent().parent().remove()
                }else
                {
                    $('#seccionComentarios').append(data.data);
                }
            });
        }

    }

    $(document).ready(function(){
        conectar();
        $('#btnComentar').click(function(){
            webSocket.send($('#comentario').val());
            $('#comentario').val("");
        });


        $(".table tbody").on('click', 'tr td button', function(){
            verificarConexion();
            webSocket.send($(this).attr("value"));
        });

    });

    function verificarConexion(){
        if(!webSocket || webSocket.readyState == 3){
            conectar();
        }
    }

</script>

<!--Script para el websocket 2 (Usuarios conectados) -->
<script>
    var webSocket2;
    var tiempoReconectar = 1000;
    function conectarUsuarios()
    {
        webSocket2 = new WebSocket("ws://"+location.hostname+":"+location.port+"/sesion");
        webSocket2.onopen = function(e){webSocket2.send("usuarios")}
        webSocket2.onclose = function(e){}
        webSocket2.onmessage = function(data){
            $(document).ready(function(){
                var cantidadUsuariosServer = JSON.parse(data.data).length
                $('#menuUsuario').html("Usuarios("+cantidadUsuariosServer+")");
            });
        }

    }

    function verificarConexionUsuarios(){
        if(!webSocket2 || webSocket2.readyState == 3){
            conectarUsuarios();
        }
    }

    setInterval(verificarConexionUsuarios, tiempoReconectar);

</script>

</body>
</html>